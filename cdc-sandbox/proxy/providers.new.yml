http:
  routers:
    # Modernization app
    login:
      service: modernization-api
      rule: "PathPrefix(`/login`)"
    modernizationForward:
      service: modernization-api
      rule: "Path(`/graphql`) || PathPrefix(`/encryption`)"
    ui-forward:
      service: modernization
      rule: "PathPrefix(`/`)"
    modernization-nbs-api:
      service: modernization-api
      rule: "PathPrefix(`/nbs/api`)"
      middlewares:
        - "modernization-nbs-api-strip"
    modernization-api-router:
      service: modernization-api
      rule: "PathPrefix(`/api`)"
      middlewares:
        - "modernization-api-strip"
    # Base /nbs forward
    nbsForward:
      service: nbs
      rule: "PathPrefix(`/nbs`)"
    # Redirect to modernization patient profile
    classic-ViewFile:
      service: modernization-api
      rule: "Query(`ContextAction=ViewFile`)"
      middlewares:
        - "patientProfileRewritepath"
    
    # NBS to modernization overrides
    simpleSearch:
      service: modernization-api
      rule: "Path(`/nbs/HomePage.do`) && Query(`method=patientSearchSubmit`)"
      middlewares:
        - "simpleSearchRewritepath"
    advancedSearch:
      service: modernization-api
      middlewares:
        - "advancedSearchRewritepath"
      rule: "Path(`/nbs/MyTaskList1.do`)&& Query(`ContextAction=GlobalPatient`)"
    manualSearch:
      service: modernization-api
      middlewares:
        - "advancedSearchRewritepath"
      rule: "Path(`/nbs/MyTaskList1.do`)&& Query(`ContextAction=GlobalMP_ManualSearch`, `Mode1=ManualMerge`)"
    # Non '/nbs' NBS routes
    nbsLogo:
      service: nbs
      rule: "Path(`/images/nedssLogo.jpg`)"
  middlewares:
    simpleSearchRewritepath:
      replacePath:
        path: /nbs/redirect/simpleSearch
    advancedSearchRewritepath:
      replacePath:
        path: /nbs/redirect/advancedSearch
    patientProfileRewritepath:
      replacePath:
        path: /nbs/redirect/patientProfile
    modernization-api-strip:
      stripPrefix:
        prefixes:
          - "/api"
    modernization-nbs-api-strip:
      stripPrefix:
        prefixes:
          - "/nbs/api"

  services:
    modernization-api:
      loadBalancer:
        servers:
          - url: 'http://{{ env "MODERNIZATION_API_SERVER" | default "modernization-api" }}:{{ env "MODERNIZATION_API_PORT" | default "8080" }}/'
    modernization:
      loadBalancer:
        servers:
          - url: 'http://{{ env "MODERNIZATION_UI_SERVER" | default "modernization-api" }}:{{ env "MODERNIZATION_UI_PORT" | default "8080" }}/'
    nbs:
      loadBalancer:
        servers:
          - url: "http://wildfly:7001/"
