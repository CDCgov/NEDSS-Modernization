http:
  routers:
    # Modernization app
    login:
      service: modernization-api
      rule: "PathPrefix(`/login`)"
    modernizationForward:
      service: modernization-api
      rule: "Path(`/graphql`) || PathPrefix(`/encryption`)"
    ui-forward:
      service: modernization
      rule: "PathPrefix(`/`)"
    # Base /nbs forward
    nbsForward:
      service: nbs
      rule: "PathPrefix(`/nbs`)"
    # Redirect to modernization patient profile
    openInvestigations: 
      service: modernization-api
      rule: "Path(`/nbs/MyProgramAreaInvestigations1.do`) && Query(`MPRUid=MPRUid:{id: [0-9]+}`, `ContextAction=ViewFile`)"
      middlewares: 
         - "patientProfileRewritepath"
    approvalQueueForInitialInvestigations:
      service: modernization-api
      rule: "Path(`/nbs/ReviewNotifications1.do`) && Query(`MPRUid=MPRUid:{id: [0-9]+}`, `ContextAction=ViewFile`)"
      middlewares:
        - "patientProfileRewritepath"
    updatedNotificationsQueue:
      service: modernization-api
      rule: "Path(`/nbs/ManageUpdatedNotifications.do`) && Query(`MPRUid=MPRUid:{id: [0-9]+}`, `ContextAction=ViewFile`)"
      middlewares:
        - "patientProfileRewritepath"
    documentsRequiringSecurityAssignment:
      service: modernization-api
      rule: "Path(`/nbs/ObsNeedingAssignment1.do`) && Query(`MPRUid=MPRUid:{id: [0-9]+}`, `ContextAction=ViewFile`)"
      middlewares: 
         - "patientProfileRewritepath"
    documentsRequiringReview:
      service: modernization-api
      rule: "Path(`/nbs/NewLabReview1`) && Query(`MPRUid=MPRUid:{id: [0-9]+}`, `ContextAction=ViewFile`)"
      middlewares:
        - "patientProfileRewritepath"
    
    # NBS to modernization overrides
    simpleSearch:
      service: modernization-api
      rule: "Path(`/nbs/HomePage.do`) && Query(`method=patientSearchSubmit`)"
      middlewares:
        - "simpleSearchRewritepath"
    advancedSearch:
      service: modernization-api
      middlewares:
        - "advancedSearchRewritepath"
      rule: "Path(`/nbs/MyTaskList1.do`)&& Query(`ContextAction=GlobalPatient`)"
    manualSearch:
      service: modernization-api
      middlewares:
        - "advancedSearchRewritepath"
      rule: "Path(`/nbs/MyTaskList1.do`)&& Query(`ContextAction=GlobalMP_ManualSearch`, `Mode1=ManualMerge`)"
    # Non '/nbs' NBS routes
    nbsLogo:
      service: nbs
      rule: "Path(`/images/nedssLogo.jpg`)"
  middlewares:
    simpleSearchRewritepath:
      replacePath:
        path: /nbs/redirect/simpleSearch
    advancedSearchRewritepath:
      replacePath:
        path: /nbs/redirect/advancedSearch
    patientProfileRewritepath:
      replacePath:
        path: /nbs/redirect/patientProfile

  services:
    modernization-api:
      loadBalancer:
        servers:
          - url: 'http://{{ env "MODERNIZATION_API_SERVER" | default "modernization-api" }}:{{ env "MODERNIZATION_API_PORT" | default "8080" }}/'
    modernization:
      loadBalancer:
        servers:
          - url: 'http://{{ env "MODERNIZATION_UI_SERVER" | default "modernization-api" }}:{{ env "MODERNIZATION_UI_PORT" | default "8080" }}/'
    nbs:
      loadBalancer:
        servers:
          - url: "http://wildfly:7001/"
