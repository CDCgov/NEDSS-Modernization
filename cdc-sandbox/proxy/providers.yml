http:
  routers:
    # Modernization app
    login:
      service: modernization-api
      rule: "PathPrefix(`/login`)"
    modernizationForward:
      service: modernization-api
      rule: "Path(`/graphql`) || PathPrefix(`/encryption`)"
    ui-forward:
      service: modernization
      rule: "PathPrefix(`/`)"
    modernization-nbs-api:
      service: modernization-api
      rule: "PathPrefix(`/nbs/api`)"
    # Base /nbs forward
    nbsForward:
      service: nbs
      rule: "PathPrefix(`/nbs`)"
    # Route to modernization Patient Profile:
    classic-patient-profile:
      service: modernization-api
      rule: "Query(`ContextAction=ViewFile`) || Query(`ContextAction=FileSummary`)"
      middlewares:
        - "patientProfileReplacePath"

    # Return to Patient Profile: Summary
    classic-patient-profile-summary-return:
      service: modernization-api
      rule: "Query(`ContextAction=ReturnToFileSummary`)"
      middlewares:
        - "patientProfileSummaryReturnReplacePath"

    # Return to Patient Profile: Events
    classic-patient-profile-events-return:
      service: modernization-api
      rule: "Query(`ContextAction=ReturnToFileEvents`)"
      middlewares:
        - "patientProfileEventsReturnReplacePath"

    classic-patient-profile-add-investigation-canceled:
      service: modernization-api
      rule: "(Path(`/nbs/SelectCondition1.do`) && Query(`ContextAction=Cancel`))"
      middlewares:
        - "patientProfileEventsReturnReplacePath"

    classic-patient-profile-investigations-merged:
      service: modernization-api
      rule: "(Path(`/nbs/PageAction.do`) && Query(`method=mergeSubmit`,`ContextAction=Submit`))"
      middlewares:
        - "patientProfileEventsReturnReplacePath"

    classic-patient-profile-add-morbidity-report-canceled:
      service: modernization-api
      rule: "(Path(`/nbs/AddObservationMorb2.do`) && Query(`ContextAction=Cancel`))"
      middlewares:
        - "patientProfileEventsReturnReplacePath"

    classic-patient-profile-add-morbidity-report-submitted:
      service: modernization-api
      rule: "Path(`/nbs/AddObservationMorb2.do`) && !Query(`ContextAction={*}`)"
      middlewares:
        - "patientProfileMorbidityReportSubmitReplacePath"

    classic-patient-profile-add-lab-report-canceled:
      service: modernization-api
      rule: "(Path(`/nbs/AddObservationLab2.do`) && Query(`ContextAction=Cancel`))"
      middlewares:
        - "patientProfileEventsReturnReplacePath"

    classic-patient-profile-add-lab-report-submitted:
      service: modernization-api
      rule: "(Path(`/nbs/AddObservationLab2.do`) && Query(`ContextAction=Submit`))"
      middlewares:
        - "patientProfileLabReportSubmitReplacePath"

    # NBS to modernization overrides
    simpleSearch:
      service: modernization-api
      rule: "Path(`/nbs/HomePage.do`) && Query(`method=patientSearchSubmit`)"
      middlewares:
        - "simpleSearchRewritepath"
    advancedSearch:
      service: modernization-api
      middlewares:
        - "advancedSearchRewritepath"
      rule: "Path(`/nbs/MyTaskList1.do`)&& Query(`ContextAction=GlobalPatient`)"
    manualSearch:
      service: modernization-api
      middlewares:
        - "advancedSearchRewritepath"
      rule: "Path(`/nbs/MyTaskList1.do`)&& Query(`ContextAction=GlobalMP_ManualSearch`, `Mode1=ManualMerge`)"
    # Non '/nbs' NBS routes
    nbsLogo:
      service: nbs
      rule: "Path(`/images/nedssLogo.jpg`)"
  middlewares:
    simpleSearchRewritepath:
      replacePath:
        path: /nbs/redirect/simpleSearch
    advancedSearchRewritepath:
      replacePath:
        path: /nbs/redirect/advancedSearch
    # Rewrite to modernization patient profile endpoints
    patientProfileReplacePath:
      replacePath:
        path: /nbs/redirect/patientProfile
    patientProfileEventsReturnReplacePath:
      replacePath:
        path: /nbs/redirect/patientProfile/events/return
    patientProfileSummaryReturnReplacePath:
      replacePath:
        path: /nbs/redirect/patientProfile/summary/return

    patientProfileMorbidityReportSubmitReplacePath:
      replacePath:
        path: /nbs/redirect/patient/report/morbidity/submit

    patientProfileLabReportSubmitReplacePath:
      replacePath:
        path: /nbs/redirect/patient/report/lab/submit

  services:
    modernization-api:
      loadBalancer:
        servers:
          - url: 'http://{{ env "MODERNIZATION_API_SERVER" | default "modernization-api" }}:{{ env "MODERNIZATION_API_PORT" | default "8080" }}/'
    modernization:
      loadBalancer:
        servers:
          - url: 'http://{{ env "MODERNIZATION_UI_SERVER" | default "modernization-api" }}:{{ env "MODERNIZATION_UI_PORT" | default "8080" }}/'
    nbs:
      loadBalancer:
        servers:
          - url: "http://wildfly:7001/"
