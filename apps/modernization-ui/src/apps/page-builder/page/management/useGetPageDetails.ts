import { PagesResponse, PagesService } from 'apps/page-builder/generated';
import { authorization } from 'authorization';
import { useEffect, useReducer } from 'react';
import { useParams } from 'react-router-dom';

type State =
    | { status: 'idle' }
    | { status: 'fetching'; page: number }
    | { status: 'refreshing'; page: number; details: PagesResponse }
    | { status: 'complete'; details: PagesResponse }
    | { status: 'error'; error: string };

type Action =
    | { type: 'fetch'; page: number }
    | { type: 'refresh'; details: PagesResponse }
    | { type: 'complete'; details: PagesResponse }
    | { type: 'error'; error: string };

const initial: State = { status: 'idle' };

const reducer = (_state: State, action: Action): State => {
    switch (action.type) {
        case 'fetch':
            return { status: 'fetching', page: action.page };
        case 'refresh':
            return { status: 'refreshing', details: action.details, page: action.details.id };
        case 'complete':
            return { status: 'complete', details: action.details };
        case 'error':
            return { status: 'error', error: action.error };
        default:
            return { ...initial };
    }
};

type Interaction = {
    loading: boolean;
    page: PagesResponse | undefined;
    fetch: (page: number) => void;
    error?: string;
    refresh: (pageDetails: PagesResponse) => void;
};

export const useGetPageDetails = (): Interaction => {
    const [state, dispatch] = useReducer(reducer, initial);
    const { pageId } = useParams();

    useEffect(() => {
        if (pageId) {
            dispatch({ type: 'fetch', page: Number(pageId) });
        }
    }, [pageId, dispatch]);

    useEffect(() => {
        if (state.status === 'fetching' || state.status === 'refreshing') {
            PagesService.detailsUsingGet({
                authorization: authorization(),
                id: state.page
            })
                .catch((error) => dispatch({ type: 'error', error: error.message }))
                .then((response) => {
                    if (response) {
                        dispatch({ type: 'complete', details: response });
                    } else {
                        dispatch({ type: 'error', error: 'Failed to retrieve page details' });
                    }
                });
        }
    }, [state]);

    const value = {
        error: state.status === 'error' ? state.error : undefined,
        loading: state.status === 'fetching',
        page: state.status === 'complete' || state.status === 'refreshing' ? state.details : undefined,
        fetch: (page: number) => dispatch({ type: 'fetch', page }),
        refresh: (pageDetails: PagesResponse) => dispatch({ type: 'refresh', details: pageDetails })
    };

    return value;
};
